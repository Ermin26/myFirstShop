<% layout('layouts/boilerplate') %>

    <style>
        .card-element {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 4px;
        }
    </style>

    <form id="payment-form" action="/checkoutToPay" method="POST">
        <div class="row row-cols-2">
            <div class="col bg-info">

                <label for="name">Ime</label>
                <input type="text" id="name" name="name" required>

                <div>
                    <label for="lastName">Priimek</label>
                    <input type="text" id="lastName" name="lastName" required>
                </div>
                <div>
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <div>
                    <label for="country">Country</label>
                    <input type="text" id="country" name="country" required>
                </div>
            </div>
            <div class="col">
                <div>
                    <label for="city">City</label>
                    <input type="text" id="city" name="city" required>
                </div>
                <div>
                    <label for="zip">ZIP Code</label>
                    <input type="text" id="zip" name="zip" required>
                </div>
                <div>
                    <label for="phone">Phone</label>
                    <input type="text" id="phone" name="phone" required>
                </div>
            </div>
            <div id="card-element">
                <!-- Stripe.js will insert the card input elements here -->
            </div>
            <button type="submit" id="submit-button">Pay Now</button>
        </div>
    </form>

    <script src="https://js.stripe.com/v3/"></script>
    <script>
        // Set up Stripe.js with your publishable key
        const stripe = Stripe(`<%= s_pk %>`);

        // Create an instance of elements
        const elements = stripe.elements();

        // Create a card element and mount it to the card element container
        const cardElement = elements.create('card');
        cardElement.mount('#card-element');

        // Handle form submission
        const form = document.getElementById('payment-form');
        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            // Disable the submit button to prevent multiple clicks
            document.getElementById('submit-button').disabled = true;

            const formData = new FormData(form);
            const firstName = formData.get('name')
            const lastName = formData.get('lastName')
            const billingDetails = {
                name: firstName + ' ' + lastName,
                email: formData.get('email'),
                address: {
                    country: formData.get('country'),
                    city: formData.get('city'),
                    street: formData.get('street'),
                    postal_code: formData.get('zip'),
                },
                phone: formData.get('phone'),
            };

            // Create a payment intent on the server
            const response = await fetch('/checkoutToPay', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    billing_details: billingDetails,
                }),
            });

            const { clientSecret } = await response.json();

            // Confirm the payment with the client secret and card details
            const result = await stripe.confirmCardPayment(clientSecret, {
                payment_method: {
                    card: cardElement,
                    billing_details: billingDetails,
                },
            });

            if (result.error) {
                // Display an error message to the user
                console.error(result.error.message);
            } else {
                // Payment successful, redirect or show a success message
                console.log('Payment succeeded!');
            }
        });
    </script>